<!-- Notification Bell Component -->
<div class="dropdown" id="notification-dropdown">
  <button class="btn btn-outline-secondary dropdown-toggle position-relative" type="button" id="notificationDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <i class="fas fa-bell"></i>
    <span class="badge badge-danger badge-pill position-absolute" id="notification-count" style="top: -5px; right: -5px; display: none;">0</span>
  </button>
  
  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
    <div class="dropdown-header d-flex justify-content-between align-items-center">
      <span>Notifications</span>
      <button class="btn btn-sm btn-link p-0" onclick="markAllNotificationsRead()">
        <small>Mark all read</small>
      </button>
    </div>
    
    <div id="notification-list">
      <div class="dropdown-item text-center">
        <div class="spinner-border spinner-border-sm" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <small class="d-block mt-1">Loading notifications...</small>
      </div>
    </div>
    
    <div class="dropdown-divider"></div>
    <a class="dropdown-item text-center" href="#" onclick="loadMoreNotifications()">
      <small>View all notifications</small>
    </a>
  </div>
</div>

<script>
let notificationOffset = 0;
const notificationLimit = 10;

function loadNotifications(append = false) {
  const url = `{{ url_for('nooks_club.api_get_notifications') }}?limit=${notificationLimit}&offset=${notificationOffset}`;
  
  fetch(url, {
    headers: {
      'X-CSRF-Token': '{{ csrf_token() }}'
    }
  })
    .then(response => response.json())
    .then(data => {
      const notificationList = document.getElementById('notification-list');
      
      if (!append) {
        notificationList.innerHTML = '';
      }
      
      if (data.notifications && data.notifications.length > 0) {
        data.notifications.forEach(notification => {
          const notificationItem = createNotificationItem(notification);
          notificationList.appendChild(notificationItem);
        });
      } else if (!append) {
        notificationList.innerHTML = '<div class="dropdown-item text-center text-muted">No notifications</div>';
      }
    })
    .catch(error => {
      console.error('Error loading notifications:', error);
      document.getElementById('notification-list').innerHTML = '<div class="dropdown-item text-center text-danger">Error loading notifications</div>';
    });
}

function createNotificationItem(notification) {
  const item = document.createElement('div');
  item.className = `dropdown-item ${notification.is_read ? '' : 'bg-light'}`;
  item.style.cursor = 'pointer';
  item.onclick = () => markNotificationRead(notification._id);
  
  const timeAgo = getTimeAgo(new Date(notification.created_at));
  
  item.innerHTML = `
    <div class="d-flex">
      <div class="flex-grow-1">
        <h6 class="dropdown-header p-0 mb-1">${DOMPurify.sanitize(notification.title)}</h6>
        <p class="mb-1 small">${DOMPurify.sanitize(notification.message)}</p>
        <small class="text-muted">${timeAgo}</small>
        ${notification.club_name ? `<small class="text-muted"> â€¢ ${DOMPurify.sanitize(notification.club_name)}</small>` : ''}
      </div>
      ${!notification.is_read ? '<div class="ml-2"><i class="fas fa-circle text-primary" style="font-size: 8px;"></i></div>' : ''}
    </div>
  `;
  
  return item;
}

function markNotificationRead(notificationId) {
  fetch(`{{ url_for('nooks_club.api_mark_notification_read', notification_id='') }}${notificationId}`, {
    method: 'POST',
    headers: {
      'X-CSRF-Token': '{{ csrf_token() }}'
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        loadNotifications(); // Reload notifications
        updateNotificationCount();
      }
    })
    .catch(error => console.error('Error marking notification as read:', error));
}

function markAllNotificationsRead() {
  fetch('{{ url_for("nooks_club.api_mark_all_notifications_read") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': '{{ csrf_token() }}'
    }
  })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        loadNotifications(); // Reload notifications
        updateNotificationCount();
      }
    })
    .catch(error => console.error('Error marking all notifications as read:', error));
}

function updateNotificationCount() {
  fetch('{{ url_for("nooks_club.api_get_unread_count") }}', {
    headers: {
      'X-CSRF-Token': '{{ csrf_token() }}'
    }
  })
    .then(response => response.json())
    .then(data => {
      const countBadge = document.getElementById('notification-count');
      if (data.unread_count > 0) {
        countBadge.textContent = data.unread_count;
        countBadge.style.display = 'block';
      } else {
        countBadge.style.display = 'none';
      }
    })
    .catch(error => console.error('Error updating notification count:', error));
}

function loadMoreNotifications() {
  notificationOffset += notificationLimit;
  loadNotifications(true);
}

function getTimeAgo(date) {
  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);
  
  if (diffInSeconds < 60) return 'Just now';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
  if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;
  return date.toLocaleDateString();
}

// Initialize notifications
document.addEventListener('DOMContentLoaded', () => {
  updateNotificationCount();
  
  // Load notifications when dropdown is opened
  document.getElementById('notificationDropdown').addEventListener('click', () => {
    loadNotifications();
  });
  
  // Update notification count periodically
  setInterval(updateNotificationCount, 30000); // Every 30 seconds
});
</script>